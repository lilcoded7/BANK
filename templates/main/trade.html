<!-- templates/trade_investment.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prestige Bank | Trade Investment</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- TradingView Widget -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <style>
        /* All CSS styles from your original template */
        /* ... (Include all CSS styles from your original template) ... */
    </style>
</head>
<body>
    
    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="logo">
                <i class="fas fa-university"></i>
                <span>Prestige</span>Bank
            </div>
            <div class="nav-menu">
                <div class="nav-item" onclick="window.location.href='{% url 'dashboard' %}'">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" onclick="window.location.href='{% url 'transfer_funds' %}'">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Transfer Funds</span>
                </div>
                <div class="nav-item" onclick="window.location.href='{% url 'mobile_money' %}'">
                    <i class="fas fa-mobile-alt"></i>
                    <span>Mobile Money</span>
                </div>
                <div class="nav-item active" onclick="window.location.href='{% url 'trade_investment' %}'">
                    <i class="fas fa-chart-line"></i>
                    <span>Trade Investment</span>
                </div>
                <div class="nav-item" onclick="window.location.href='{% url 'security_settings' %}'">
                    <i class="fas fa-shield-alt"></i>
                    <span>Security</span>
                </div>
                <div class="nav-item" onclick="window.location.href='{% url 'logout' %}'">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button class="mobile-menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="page-title">Trade Investment</div>
                </div>
                <div class="user-profile">
                    <div class="user-avatar">
                        {% if user.is_biometric_enabled %}
                            <i class="fas fa-fingerprint"></i>
                        {% else %}
                            {{ user.first_name|first }}{{ user.last_name|first }}
                        {% endif %}
                    </div>
                    <div class="user-name">{{ user.first_name }} {{ user.last_name }}</div>
                </div>
            </div>

            <!-- Display messages -->
            {% if messages %}
                {% for message in messages %}
                    <div class="message message-{% if message.tags %}{{ message.tags }}{% endif %}">
                        <i class="fas 
                            {% if message.tags == 'success' %}fa-check-circle
                            {% elif message.tags == 'error' %}fa-exclamation-circle
                            {% else %}fa-info-circle{% endif %}"></i>
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Deposit button in corner -->
            <div class="deposit-corner">
                <button class="btn btn-primary" onclick="openModal('Deposit Funds', 'depositForm')">
                    <i class="fas fa-plus"></i> Deposit Funds
                </button>
            </div>

            <!-- Market Overview -->
            <div class="dashboard-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Investment Balance</div>
                        <div class="card-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                    </div>
                    <div class="card-value">${{ investment_balance|floatformat:2 }}</div>
                    <div class="card-change">
                        <i class="fas fa-arrow-up"></i>
                        <span>+5.2% this month</span>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Active Trades</div>
                        <div class="card-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <div class="card-value">{{ active_trades }}</div>
                    <div class="card-change">
                        <i class="fas fa-clock"></i>
                        <span>{{ pending_trades }} pending</span>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Total Profit</div>
                        <div class="card-icon">
                            <i class="fas fa-coins"></i>
                        </div>
                    </div>
                    <div class="card-value">${{ total_profit|floatformat:2 }}</div>
                    <div class="card-change {% if total_profit < 0 %}negative{% endif %}">
                        <i class="fas {% if total_profit >= 0 %}fa-arrow-up{% else %}fa-arrow-down{% endif %}"></i>
                        <span>{{ total_profit|floatformat:2 }}% all time</span>
                    </div>
                </div>
            </div>

            <!-- TradingView Chart -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">Live Market Chart</div>
                    <div>
                        <select id="symbolSelect" class="form-control" style="width: auto; display: inline-block;">
                            <option value="BINANCE:BTCUSDT">BTC/USDT</option>
                            <option value="BINANCE:ETHUSDT">ETH/USDT</option>
                            <option value="BINANCE:BNBUSDT">BNB/USDT</option>
                            <option value="BINANCE:SOLUSDT">SOL/USDT</option>
                            <option value="BINANCE:XRPUSDT">XRP/USDT</option>
                        </select>
                    </div>
                </div>
                <div class="tradingview-chart" id="tradingview-chart"></div>
            </div>

            <!-- Investment Packages (hidden if user has active investment) -->
            {% if not has_active_investment %}
            <div class="section">
                <div class="section-header">
                    <div class="section-title">Investment Packages</div>
                    <a href="#" class="section-link" onclick="openModal('Deposit Funds', 'depositForm')">Deposit Funds</a>
                </div>
                <div class="investment-packages">
                    {% for package in packages %}
                    <div class="package-card" onclick="selectPackage(this, '{{ package.id }}')">
                        <div class="package-name">{{ package.get_name_display }}</div>
                        <div class="package-amount">${{ package.min_amount }} - ${{ package.max_amount }}</div>
                        <div class="package-duration">{{ package.duration_days }} Days Investment</div>
                        <div class="package-roi">Up to {{ package.roi_percentage }}% ROI</div>
                        <ul class="package-features">
                            {% for feature in package.features %}
                            <li>{{ feature }}</li>
                            {% endfor %}
                        </ul>
                        <button class="btn btn-outline" 
                            onclick="openInvestmentModal('{{ package.id }}')">
                            Invest Now
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Trade Panel -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">Trade Panel</div>
                </div>
                <div class="trade-panel">
                    <form id="openTradeForm" method="post" action="{% url 'open_trade' %}">
                        {% csrf_token %}
                        <div class="trade-form">
                            <h3 style="margin-bottom: 1.5rem; color: var(--primary);">Open New Position</h3>
                            <div class="form-group">
                                <label for="tradeSymbol">Symbol</label>
                                <select id="tradeSymbol" name="symbol" class="form-control">
                                    <option value="BTCUSDT">BTC/USDT</option>
                                    <option value="ETHUSDT">ETH/USDT</option>
                                    <option value="BNBUSDT">BNB/USDT</option>
                                    <option value="SOLUSDT">SOL/USDT</option>
                                    <option value="XRPUSDT">XRP/USDT</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="tradeType">Trade Type</label>
                                <select id="tradeType" name="trade_type" class="form-control">
                                    <option value="BUY">Buy (Long)</option>
                                    <option value="SELL">Sell (Short)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="tradeAmount">Amount ($)</label>
                                <input type="number" id="tradeAmount" name="amount" class="form-control" 
                                    placeholder="Enter amount" min="{{ bank_settings.min_trade_amount }}" step="10" required>
                                <small class="text-muted">Min: ${{ bank_settings.min_trade_amount }}</small>
                            </div>
                            <div class="form-group">
                                <label for="leverage">Leverage</label>
                                <select id="leverage" name="leverage" class="form-control">
                                    {% for i in "123456789"|make_list %}
                                        {% if forloop.counter <= bank_settings.max_leverage %}
                                            <option value="{{ forloop.counter }}" {% if forloop.counter == 10 %}selected{% endif %}>
                                                1:{{ forloop.counter }}
                                            </option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Max: 1:{{ bank_settings.max_leverage }}</small>
                            </div>
                            <div class="form-group">
                                <label for="takeProfit">Take Profit (%)</label>
                                <input type="number" id="takeProfit" name="take_profit" class="form-control" 
                                    placeholder="e.g. 5" min="0.1" step="0.1" value="5" required>
                            </div>
                            <div class="form-group">
                                <label for="stopLoss">Stop Loss (%)</label>
                                <input type="number" id="stopLoss" name="stop_loss" class="form-control" 
                                    placeholder="e.g. 2" min="0.1" step="0.1" value="2" required>
                            </div>
                            <input type="hidden" id="entryPrice" name="entry_price" value="0">
                            <button type="submit" class="btn btn-success btn-block">Buy (Long)</button>
                        </form>
                        <form method="post" action="{% url 'open_trade' %}" style="margin-top: 0.5rem;">
                            {% csrf_token %}
                            <input type="hidden" name="symbol" id="sellSymbol">
                            <input type="hidden" name="trade_type" value="SELL">
                            <input type="hidden" name="amount" id="sellAmount">
                            <input type="hidden" name="leverage" id="sellLeverage">
                            <input type="hidden" name="take_profit" id="sellTakeProfit">
                            <input type="hidden" name="stop_loss" id="sellStopLoss">
                            <input type="hidden" name="entry_price" id="sellEntryPrice">
                            <button type="submit" class="btn btn-danger btn-block">Sell (Short)</button>
                        </form>
                    </div>
                    
                    <div class="trade-form">
                        <h3 style="margin-bottom: 1.5rem; color: var(--primary);">Trade Information</h3>
                        <div class="trade-info-cards">
                            <div class="info-card">
                                <div class="info-card-title">Current Price</div>
                                <div class="info-card-value" id="currentPrice">$0.00</div>
                                <div class="info-card-change" id="priceChange">+0.00%</div>
                            </div>
                            <div class="info-card">
                                <div class="info-card-title">24h High</div>
                                <div class="info-card-value" id="dailyHigh">$0.00</div>
                            </div>
                            <div class="info-card">
                                <div class="info-card-title">24h Low</div>
                                <div class="info-card-value" id="dailyLow">$0.00</div>
                            </div>
                            <div class="info-card">
                                <div class="info-card-title">24h Volume</div>
                                <div class="info-card-value" id="dailyVolume">$0.00</div>
                            </div>
                        </div>
                        
                        <h4 style="margin: 1.5rem 0 1rem; color: var(--primary);">Position Summary</h4>
                        <div class="form-group">
                            <label>Investment Amount</label>
                            <div class="form-control" style="background: #f9f9f9;" id="summaryAmount">$0.00</div>
                        </div>
                        <div class="form-group">
                            <label>Potential Profit</label>
                            <div class="form-control" style="background: #f9f9f9;" id="summaryProfit">$0.00</div>
                        </div>
                        <div class="form-group">
                            <label>Potential Loss</label>
                            <div class="form-control" style="background: #f9f9f9;" id="summaryLoss">$0.00</div>
                        </div>
                        <div class="form-group">
                            <label>Margin Required</label>
                            <div class="form-control" style="background: #f9f9f9;" id="summaryMargin">$0.00</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Positions -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">Active Positions</div>
                </div>
                <div class="card">
                    {% if active_positions %}
                    <table class="positions-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Type</th>
                                <th>Entry Price</th>
                                <th>Current Price</th>
                                <th>Amount</th>
                                <th>Profit/Loss</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for position in active_positions %}
                            <tr>
                                <td>{{ position.symbol }}</td>
                                <td>{{ position.get_trade_type_display }}</td>
                                <td>${{ position.entry_price|floatformat:2 }}</td>
                                <td>${{ position.current_price|floatformat:2 }}</td>
                                <td>${{ position.amount|floatformat:2 }}</td>
                                <td class="{% if position.profit_loss >= 0 %}profit-positive{% else %}profit-negative{% endif %}">
                                    ${{ position.profit_loss|floatformat:2 }}
                                </td>
                                <td>
                                    <form method="post" action="{% url 'close_trade' position.id %}" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="action-btn btn-success">Close</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="message message-info">
                        <i class="fas fa-info-circle"></i>
                        You have no active positions. Open a new position to start trading.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- AI Assistant Floating Button -->
    <div class="assistant" onclick="alert('AI Trading Assistant coming soon!')">
        <i class="fas fa-robot"></i>
    </div>

    <!-- Deposit Modal -->
    <div class="modal-overlay" id="depositModal">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="depositModalTitle">Deposit Funds</h3>
                <button class="modal-close" onclick="closeModal('depositModal')">&times;</button>
            </div>
            <div class="modal-body" id="depositModalBody">
                <form id="depositForm" method="post" action="{% url 'deposit_funds' %}">
                    {% csrf_token %}
                    <div class="form-group">
                        <label>From Account</label>
                        <select class="form-control" name="from_account" required>
                            {% for account in accounts %}
                                {% if account.account_type != "INVESTMENT" %}
                                <option value="{{ account.id }}">
                                    {{ account.account_number }} - ${{ account.balance|floatformat:2 }}
                                </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>To Investment Account</label>
                        <select class="form-control" name="to_account" required>
                            {% for account in accounts %}
                                {% if account.account_type == "INVESTMENT" %}
                                <option value="{{ account.id }}">
                                    {{ account.account_number }} - ${{ account.balance|floatformat:2 }}
                                </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Currency</label>
                        <select class="form-control" name="currency" required>
                            <option value="BTC">Bitcoin (BTC)</option>
                            <option value="ETH">Ethereum (ETH)</option>
                            <option value="USDT">Tether (USDT)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount ($)</label>
                        <input type="number" class="form-control" name="amount" 
                            placeholder="Enter amount" min="10" step="1" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Generate Deposit Address</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Investment Modal -->
    <div class="modal-overlay" id="investmentModal">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="investmentModalTitle">Create Investment</h3>
                <button class="modal-close" onclick="closeModal('investmentModal')">&times;</button>
            </div>
            <div class="modal-body" id="investmentModalBody">
                <form id="investmentForm" method="post" action="{% url 'create_investment' %}">
                    {% csrf_token %}
                    <input type="hidden" name="package" id="selectedPackageId">
                    <div class="form-group">
                        <label>From Account</label>
                        <select class="form-control" name="from_account" required>
                            {% for account in accounts %}
                                {% if account.account_type != "INVESTMENT" %}
                                <option value="{{ account.id }}">
                                    {{ account.account_number }} - ${{ account.balance|floatformat:2 }}
                                </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount ($)</label>
                        <input type="number" class="form-control" name="amount" 
                            placeholder="Enter amount" min="100" step="10" required
                            id="investmentAmount">
                        <small class="text-muted" id="packageMinMax">Minimum: $100, Maximum: $5,000</small>
                    </div>
                    <div class="form-group">
                        <label>Expected ROI</label>
                        <input type="text" class="form-control" id="expectedROI" readonly value="">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Create Investment</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Mobile Menu Toggle
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        
        menuToggle.addEventListener('click', function(e) {
            e.stopPropagation();
            sidebar.classList.toggle('active');
        });
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(e) {
            if (window.innerWidth <= 992 && !sidebar.contains(e.target)) {
                sidebar.classList.remove('active');
            }
        });

        // Prevent clicks inside sidebar from closing it
        sidebar.addEventListener('click', function(e) {
            e.stopPropagation();
        });

        // TradingView Widget
        function initTradingView(symbol = 'BINANCE:BTCUSDT') {
            new TradingView.widget({
                "autosize": true,
                "symbol": symbol,
                "interval": "15",
                "timezone": "Etc/UTC",
                "theme": "light",
                "style": "1",
                "locale": "en",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "allow_symbol_change": true,
                "container_id": "tradingview-chart"
            });
        }

        // Initialize with default symbol
        initTradingView();

        // Symbol selector change
        document.getElementById('symbolSelect').addEventListener('change', function() {
            const symbol = this.value;
            document.getElementById('tradingview-chart').innerHTML = '';
            initTradingView(symbol);
            
            // Update trade panel symbol to match
            const tradeSymbol = symbol.split(':')[1] || symbol;
            document.getElementById('tradeSymbol').value = tradeSymbol;
            
            // Update market data
            updateMarketData(tradeSymbol);
        });

        // Trade symbol selector change
        document.getElementById('tradeSymbol').addEventListener('change', function() {
            const symbol = this.value;
            updateMarketData(symbol);
        });

        // Fetch market data from backend
        function updateMarketData(symbol) {
            fetch(`/market_data/${symbol}/`)
                .then(response => response.json())
                .then(data => {
                    const changeColor = data.change >= 0 ? 'var(--success)' : 'var(--danger)';
                    
                    document.getElementById('currentPrice').textContent = '$' + data.price.toFixed(2);
                    document.getElementById('priceChange').textContent = (data.change >= 0 ? '+' : '') + data.change.toFixed(2) + '%';
                    document.getElementById('priceChange').style.color = changeColor;
                    document.getElementById('dailyHigh').textContent = '$' + data.high.toFixed(2);
                    document.getElementById('dailyLow').textContent = '$' + data.low.toFixed(2);
                    document.getElementById('dailyVolume').textContent = '$' + data.volume.toLocaleString();
                    
                    // Set entry price for form
                    document.getElementById('entryPrice').value = data.price;
                    
                    // Update trade calculations
                    updateTradeCalculations();
                });
        }

        // Package selection
        function selectPackage(element, packageId) {
            // Remove selected class from all packages
            document.querySelectorAll('.package-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selected class to clicked package
            element.classList.add('selected');
        }

        // Open investment modal
        function openInvestmentModal(packageId) {
            const modal = document.getElementById('investmentModal');
            const modalTitle = document.getElementById('investmentModalTitle');
            const packageSelect = document.getElementById('selectedPackageId');
            
            // Get package details
            const package = Array.from(document.querySelectorAll('.package-card'))
                .find(card => card.getAttribute('onclick').includes(packageId));
            
            if (!package) return;
            
            const packageName = package.querySelector('.package-name').textContent;
            const minAmount = parseFloat(package.querySelector('.package-amount').textContent.split(' - ')[0].replace('$', ''));
            const maxAmount = parseFloat(package.querySelector('.package-amount').textContent.split(' - ')[1].replace('$', ''));
            const roiPercentage = parseFloat(package.querySelector('.package-roi').textContent.match(/(\d+)/)[0]);
            
            // Update modal
            modalTitle.textContent = `Invest in ${packageName}`;
            packageSelect.value = packageId;
            document.getElementById('investmentAmount').min = minAmount;
            document.getElementById('investmentAmount').max = maxAmount;
            document.getElementById('packageMinMax').textContent = `Minimum: $${minAmount}, Maximum: $${maxAmount}`;
            
            // Set ROI calculation
            document.getElementById('investmentAmount').oninput = function() {
                const amount = parseFloat(this.value) || 0;
                const roi = amount * (roiPercentage / 100);
                document.getElementById('expectedROI').value = `$${roi.toFixed(2)} (${roiPercentage}%)`;
            };
            
            // Trigger initial calculation
            document.getElementById('investmentAmount').dispatchEvent(new Event('input'));
            
            modal.classList.add('active');
        }

        // Modal functions
        function openModal(title, formId) {
            const modal = document.getElementById('depositModal');
            const modalTitle = document.getElementById('depositModalTitle');
            
            modalTitle.textContent = title;
            modal.classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Trade calculations
        function updateTradeCalculations() {
            const amount = parseFloat(document.getElementById('tradeAmount').value) || 0;
            const leverage = parseInt(document.getElementById('leverage').value) || 1;
            const takeProfit = parseFloat(document.getElementById('takeProfit').value) || 0;
            const stopLoss = parseFloat(document.getElementById('stopLoss').value) || 0;
            const currentPrice = parseFloat(document.getElementById('currentPrice').textContent.replace('$', '')) || 0;
            
            if (currentPrice === 0) return;
            
            const margin = amount / leverage;
            const potentialProfit = amount * (takeProfit / 100);
            const potentialLoss = amount * (stopLoss / 100);
            
            document.getElementById('summaryAmount').textContent = '$' + amount.toFixed(2);
            document.getElementById('summaryMargin').textContent = '$' + margin.toFixed(2);
            document.getElementById('summaryProfit').textContent = '$' + potentialProfit.toFixed(2);
            document.getElementById('summaryLoss').textContent = '$' + potentialLoss.toFixed(2);
            
            // Set values for sell form
            document.getElementById('sellSymbol').value = document.getElementById('tradeSymbol').value;
            document.getElementById('sellAmount').value = amount;
            document.getElementById('sellLeverage').value = leverage;
            document.getElementById('sellTakeProfit').value = takeProfit;
            document.getElementById('sellStopLoss').value = stopLoss;
            document.getElementById('sellEntryPrice').value = currentPrice;
        }

        // Form validation
        document.getElementById('openTradeForm').addEventListener('submit', function(e) {
            const amount = parseFloat(document.getElementById('tradeAmount').value) || 0;
            const minAmount = parseFloat("{{ bank_settings.min_trade_amount }}");
            
            if (amount < minAmount) {
                e.preventDefault();
                alert(`Minimum trade amount is $${minAmount}`);
            }
        });

        // Event listeners for trade calculations
        document.getElementById('tradeAmount').addEventListener('input', updateTradeCalculations);
        document.getElementById('leverage').addEventListener('change', updateTradeCalculations);
        document.getElementById('takeProfit').addEventListener('input', updateTradeCalculations);
        document.getElementById('stopLoss').addEventListener('input', updateTradeCalculations);

        // Initialize with default values
        updateMarketData('BTCUSDT');
    </script>
</body>
</html>