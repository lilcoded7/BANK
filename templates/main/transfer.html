{% extends "main/base.html" %}

{% block content %}
<div class="main-content">
    <!-- Header -->
    <div class="header">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <button class="mobile-menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="page-title">Transfer Funds</div>
        </div>
        <div class="user-profile">
            <div class="user-avatar"><i class="fas fa-user-circle"></i></div>
            <div class="user-name">{{ request.user.get_full_name }}</div>
        </div>
    </div>

    <!-- Transaction Types -->
    <div class="transaction-types">
        <div class="transaction-type-btn" data-type="TRANSFER">
            <i class="fas fa-exchange-alt"></i><span>Bank Transfer</span>
        </div>
        <div class="transaction-type-btn" data-type="MOBILE_MONEY">
            <i class="fas fa-mobile-alt"></i><span>Mobile Money</span>
        </div>
        <div class="transaction-type-btn" data-type="DEPOSIT">
            <i class="fas fa-money-bill-wave"></i><span>Deposit</span>
        </div>
        <div class="transaction-type-btn" data-type="WITHDRAWAL">
            <i class="fas fa-hand-holding-usd"></i><span>Withdrawal</span>
        </div>
        <div class="transaction-type-btn" data-type="BILL_PAYMENT">
            <i class="fas fa-file-invoice-dollar"></i><span>Bill Payment</span>
        </div>
    </div>

    <!-- Bank Transfer Form -->
    <div class="transfer-container" id="transferForm">
        <h2>Bank Transfer</h2>
        <form method="POST" action="{% url 'bank_transfer' %}">
            {% csrf_token %}
            {{ transfer_form.as_p }}
            <div class="form-actions">
                <button type="submit" class="btn btn-block">Transfer Funds</button>
                <button type="button" class="btn btn-block btn-cancel" onclick="closeAllForms()">Cancel</button>
            </div>
        </form>
    </div>

    <!-- Mobile Money Form -->
    <div class="transfer-container" id="mobileMoneyForm">
        <h2>Mobile Money</h2>
        <form method="POST" action="{% url 'mobile_money' %}">
            {% csrf_token %}
            {{ mobile_money_form.as_p }}
            <div class="form-actions">
                <button type="submit" class="btn btn-block">Send Money</button>
                <button type="button" class="btn btn-block btn-cancel" onclick="closeAllForms()">Cancel</button>
            </div>
        </form>
    </div>

    <!-- Deposit Form -->
    <div class="transfer-container" id="depositForm">
        <h2>Deposit</h2>
        <form method="POST">
            {% csrf_token %}
            <input type="hidden" name="transaction_type" value="DEPOSIT">
            <div class="form-group">
                <label for="deposit_account">To Account</label>
                <select class="form-control" name="to_account" required>
                    <option value="">Select Account</option>
                    {% for account in accounts %}
                        <option value="{{ account.id }}">
                            {{ account.account_number }} - {{ account.get_account_type_display }}
                            (GHS {{ account.balance }})
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Amount (GHS)</label>
                <input type="number" name="amount" class="form-control" required min="1" step="0.01">
            </div>
            <div class="form-group">
                <label>Description (Optional)</label>
                <input type="text" name="description" class="form-control">
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-block">Deposit Funds</button>
                <button type="button" class="btn btn-block btn-cancel" onclick="closeAllForms()">Cancel</button>
            </div>
        </form>
    </div>

    <!-- Withdrawal Form -->
    <div class="transfer-container" id="withdrawalForm">
        <h2>Withdrawal</h2>
        <form method="POST">
            {% csrf_token %}
            <input type="hidden" name="transaction_type" value="WITHDRAWAL">
            <div class="form-group">
                <label for="withdrawal_account">From Account</label>
                <select class="form-control" name="from_account" required>
                    <option value="">Select Account</option>
                    {% for account in accounts %}
                        <option value="{{ account.id }}">
                            {{ account.account_number }} - {{ account.get_account_type_display }}
                            (GHS {{ account.balance }})
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Amount (GHS)</label>
                <input type="number" name="amount" class="form-control" required min="1" step="0.01">
            </div>
            <div class="form-group">
                <label>Description (Optional)</label>
                <input type="text" name="description" class="form-control">
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-block">Withdraw Funds</button>
                <button type="button" class="btn btn-block btn-cancel" onclick="closeAllForms()">Cancel</button>
            </div>
        </form>
    </div>

    <!-- Bill Payment Form -->
    <div class="transfer-container" id="billPaymentForm">
        <h2>Bill Payment</h2>
        <form method="POST" action="{% url 'bill_payment' %}">
            {% csrf_token %}
            {{ bill_payment_form.as_p }}
            <div class="form-actions">
                <button type="submit" class="btn btn-block">Pay Bill</button>
                <button type="button" class="btn btn-block btn-cancel" onclick="closeAllForms()">Cancel</button>
            </div>
        </form>
    </div>

    <!-- Transaction History -->
    <div class="transactions-section">
        <div class="transactions-header">
            <h2 class="section-title">Transaction History</h2>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="completed">Completed</button>
                <button class="filter-btn" data-filter="pending">Pending</button>
                <button class="filter-btn" data-filter="failed">Failed</button>
            </div>
        </div>

        <table class="transactions-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>From/To</th>
                    <th>Amount</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for tx in recent_transactions %}
                <tr class="transaction-row" data-status="{{ tx.status|lower }}">
                    <td>{{ tx.timestamp|date:"M d, Y H:i" }}</td>
                    <td>{{ tx.description }}</td>
                    <td>
                        {% if tx.sender_account %}
                            From: {{ tx.sender_account.account_number }}
                        {% endif %}
                        {% if tx.recipient_account %}
                            To: {{ tx.recipient_account.account_number }}
                        {% endif %}
                    </td>
                    <td class="transaction-amount {% if tx.transaction_type in 'DEBIT,WITHDRAWAL' %}debit{% else %}credit{% endif %}">
                        {% if tx.transaction_type in 'DEBIT,WITHDRAWAL' %}-{% else %}+{% endif %}â‚µ{{ tx.amount }}
                    </td>
                    <td>
                        <span class="transaction-status status-{{ tx.status|lower }}">
                            {{ tx.get_status_display }}
                        </span>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="text-align: center;">No transactions found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Scripts -->
<script>
    const sidebar = document.getElementById('sidebar');
    document.getElementById('menuToggle').addEventListener('click', e => {
        e.stopPropagation();
        sidebar.classList.toggle('active');
    });
    document.addEventListener('click', e => {
        if (window.innerWidth <= 992 && !sidebar.contains(e.target)) sidebar.classList.remove('active');
    });

    const formMap = {
        TRANSFER: "transferForm",
        MOBILE_MONEY: "mobileMoneyForm",
        DEPOSIT: "depositForm",
        WITHDRAWAL: "withdrawalForm",
        BILL_PAYMENT: "billPaymentForm"
    };
    document.querySelectorAll('.transaction-type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            closeAllForms();
            document.querySelectorAll('.transaction-type-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const formElement = document.getElementById(formMap[btn.dataset.type]);
            if (formElement) {
                formElement.style.display = 'block';
                window.scrollTo({ top: formElement.offsetTop - 20, behavior: 'smooth' });
            }
        });
    });
    function closeAllForms() {
        document.querySelectorAll('.transfer-container').forEach(form => form.style.display = 'none');
        document.querySelectorAll('.transaction-type-btn').forEach(btn => btn.classList.remove('active'));
    }

    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const filter = btn.dataset.filter;
            document.querySelectorAll('.transaction-row').forEach(row => {
                row.style.display = (filter === 'all' || row.dataset.status === filter) ? '' : 'none';
            });
        });
    });
</script>
{% endblock %}
