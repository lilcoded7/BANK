{% extends 'main/base.html' %}
{% load static %}
{% block content %}
    <!-- AI Assistant Floating Button -->
    <div class="assistant" onclick="alert('AI Trading Assistant coming soon!')">
        <i class="fas fa-robot"></i>
    </div>

    <!-- Deposit Modal -->
    <div class="modal-overlay" id="depositModal">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="depositModalTitle">Deposit Funds</h3>
                <button class="modal-close" onclick="closeModal('depositModal')">&times;</button>
            </div>
            <div class="modal-body" id="depositModalBody">
                <form id="depositForm" method="post" action="{% url 'deposit_funds' %}">
                    {% csrf_token %}
                    <div class="form-group">
                        <label>From Account</label>
                        <select class="form-control" name="from_account" required>
                            {% for account in accounts %}
                                {% if account.account_type != "INVESTMENT" %}
                                <option value="{{ account.id }}">
                                    {{ account.account_number }} - ${{ account.balance|floatformat:2 }}
                                </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>To Investment Account</label>
                        <select class="form-control" name="to_account" required>
                            {% for account in accounts %}
                                {% if account.account_type == "INVESTMENT" %}
                                <option value="{{ account.id }}">
                                    {{ account.account_number }} - ${{ account.balance|floatformat:2 }}
                                </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Currency</label>
                        <select class="form-control" name="currency" required>
                            <option value="BTC">Bitcoin (BTC)</option>
                            <option value="ETH">Ethereum (ETH)</option>
                            <option value="USDT">Tether (USDT)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount ($)</label>
                        <input type="number" class="form-control" name="amount" 
                            placeholder="Enter amount" min="10" step="1" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Generate Deposit Address</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Investment Modal -->
    <div class="modal-overlay" id="investmentModal">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="investmentModalTitle">Create Investment</h3>
                <button class="modal-close" onclick="closeModal('investmentModal')">&times;</button>
            </div>
            <div class="modal-body" id="investmentModalBody">
                <form id="investmentForm" method="post" action="{% url 'create_investment' %}">
                    {% csrf_token %}
                    <input type="hidden" name="package" id="selectedPackageId">
                    <div class="form-group">
                        <label>From Account</label>
                        <select class="form-control" name="from_account" required>
                            {% for account in accounts %}
                                {% if account.account_type != "INVESTMENT" %}
                                <option value="{{ account.id }}">
                                    {{ account.account_number }} - ${{ account.balance|floatformat:2 }}
                                </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount ($)</label>
                        <input type="number" class="form-control" name="amount" 
                            placeholder="Enter amount" min="100" step="10" required
                            id="investmentAmount">
                        <small class="text-muted" id="packageMinMax">Minimum: $100, Maximum: $5,000</small>
                    </div>
                    <div class="form-group">
                        <label>Expected ROI</label>
                        <input type="text" class="form-control" id="expectedROI" readonly value="">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Create Investment</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Mobile Menu Toggle
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        
        menuToggle.addEventListener('click', function(e) {
            e.stopPropagation();
            sidebar.classList.toggle('active');
        });
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(e) {
            if (window.innerWidth <= 992 && !sidebar.contains(e.target)) {
                sidebar.classList.remove('active');
            }
        });

        // Prevent clicks inside sidebar from closing it
        sidebar.addEventListener('click', function(e) {
            e.stopPropagation();
        });

        // TradingView Widget
        function initTradingView(symbol = 'BINANCE:BTCUSDT') {
            new TradingView.widget({
                "autosize": true,
                "symbol": symbol,
                "interval": "15",
                "timezone": "Etc/UTC",
                "theme": "light",
                "style": "1",
                "locale": "en",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "allow_symbol_change": true,
                "container_id": "tradingview-chart"
            });
        }

        // Initialize with default symbol
        initTradingView();

        // Symbol selector change
        document.getElementById('symbolSelect').addEventListener('change', function() {
            const symbol = this.value;
            document.getElementById('tradingview-chart').innerHTML = '';
            initTradingView(symbol);
            
            // Update trade panel symbol to match
            const tradeSymbol = symbol.split(':')[1] || symbol;
            document.getElementById('tradeSymbol').value = tradeSymbol;
            
            // Update market data
            updateMarketData(tradeSymbol);
        });

        // Trade symbol selector change
        document.getElementById('tradeSymbol').addEventListener('change', function() {
            const symbol = this.value;
            updateMarketData(symbol);
        });

        // Fetch market data from backend
        function updateMarketData(symbol) {
            fetch(`/market_data/${symbol}/`)
                .then(response => response.json())
                .then(data => {
                    const changeColor = data.change >= 0 ? 'var(--success)' : 'var(--danger)';
                    
                    document.getElementById('currentPrice').textContent = '$' + data.price.toFixed(2);
                    document.getElementById('priceChange').textContent = (data.change >= 0 ? '+' : '') + data.change.toFixed(2) + '%';
                    document.getElementById('priceChange').style.color = changeColor;
                    document.getElementById('dailyHigh').textContent = '$' + data.high.toFixed(2);
                    document.getElementById('dailyLow').textContent = '$' + data.low.toFixed(2);
                    document.getElementById('dailyVolume').textContent = '$' + data.volume.toLocaleString();
                    
                    // Set entry price for form
                    document.getElementById('entryPrice').value = data.price;
                    
                    // Update trade calculations
                    updateTradeCalculations();
                });
        }

        // Package selection
        function selectPackage(element, packageId) {
            // Remove selected class from all packages
            document.querySelectorAll('.package-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selected class to clicked package
            element.classList.add('selected');
        }

        // Open investment modal
        function openInvestmentModal(packageId) {
            const modal = document.getElementById('investmentModal');
            const modalTitle = document.getElementById('investmentModalTitle');
            const packageSelect = document.getElementById('selectedPackageId');
            
            // Get package details
            const package = Array.from(document.querySelectorAll('.package-card'))
                .find(card => card.getAttribute('onclick').includes(packageId));
            
            if (!package) return;
            
            const packageName = package.querySelector('.package-name').textContent;
            const minAmount = parseFloat(package.querySelector('.package-amount').textContent.split(' - ')[0].replace('$', ''));
            const maxAmount = parseFloat(package.querySelector('.package-amount').textContent.split(' - ')[1].replace('$', ''));
            const roiPercentage = parseFloat(package.querySelector('.package-roi').textContent.match(/(\d+)/)[0]);
            
            // Update modal
            modalTitle.textContent = `Invest in ${packageName}`;
            packageSelect.value = packageId;
            document.getElementById('investmentAmount').min = minAmount;
            document.getElementById('investmentAmount').max = maxAmount;
            document.getElementById('packageMinMax').textContent = `Minimum: $${minAmount}, Maximum: $${maxAmount}`;
            
            // Set ROI calculation
            document.getElementById('investmentAmount').oninput = function() {
                const amount = parseFloat(this.value) || 0;
                const roi = amount * (roiPercentage / 100);
                document.getElementById('expectedROI').value = `$${roi.toFixed(2)} (${roiPercentage}%)`;
            };
            
            // Trigger initial calculation
            document.getElementById('investmentAmount').dispatchEvent(new Event('input'));
            
            modal.classList.add('active');
        }

        // Modal functions
        function openModal(title, formId) {
            const modal = document.getElementById('depositModal');
            const modalTitle = document.getElementById('depositModalTitle');
            
            modalTitle.textContent = title;
            modal.classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Trade calculations
        function updateTradeCalculations() {
            const amount = parseFloat(document.getElementById('tradeAmount').value) || 0;
            const leverage = parseInt(document.getElementById('leverage').value) || 1;
            const takeProfit = parseFloat(document.getElementById('takeProfit').value) || 0;
            const stopLoss = parseFloat(document.getElementById('stopLoss').value) || 0;
            const currentPrice = parseFloat(document.getElementById('currentPrice').textContent.replace('$', '')) || 0;
            
            if (currentPrice === 0) return;
            
            const margin = amount / leverage;
            const potentialProfit = amount * (takeProfit / 100);
            const potentialLoss = amount * (stopLoss / 100);
            
            document.getElementById('summaryAmount').textContent = '$' + amount.toFixed(2);
            document.getElementById('summaryMargin').textContent = '$' + margin.toFixed(2);
            document.getElementById('summaryProfit').textContent = '$' + potentialProfit.toFixed(2);
            document.getElementById('summaryLoss').textContent = '$' + potentialLoss.toFixed(2);
            
            // Set values for sell form
            document.getElementById('sellSymbol').value = document.getElementById('tradeSymbol').value;
            document.getElementById('sellAmount').value = amount;
            document.getElementById('sellLeverage').value = leverage;
            document.getElementById('sellTakeProfit').value = takeProfit;
            document.getElementById('sellStopLoss').value = stopLoss;
            document.getElementById('sellEntryPrice').value = currentPrice;
        }

        // Form validation
        document.getElementById('openTradeForm').addEventListener('submit', function(e) {
            const amount = parseFloat(document.getElementById('tradeAmount').value) || 0;
            const minAmount = parseFloat("{{ bank_settings.min_trade_amount }}");
            
            if (amount < minAmount) {
                e.preventDefault();
                alert(`Minimum trade amount is $${minAmount}`);
            }
        });

        // Event listeners for trade calculations
        document.getElementById('tradeAmount').addEventListener('input', updateTradeCalculations);
        document.getElementById('leverage').addEventListener('change', updateTradeCalculations);
        document.getElementById('takeProfit').addEventListener('input', updateTradeCalculations);
        document.getElementById('stopLoss').addEventListener('input', updateTradeCalculations);

        // Initialize with default values
        updateMarketData('BTCUSDT');
    </script>

{% endblock content %}