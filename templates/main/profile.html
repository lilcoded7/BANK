{% extends "main/base.html" %}

{% block content %}
<div class="main-content">
    <!-- Header -->
    <div class="header">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <button class="mobile-menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="page-title">My Profile</div>
        </div>
        <div class="user-profile">
            <div class="user-avatar">
                {% if customer.image %}
                    <img src="{{ customer.image.url }}" alt="Profile Picture" class="profile-avatar-img">
                {% else %}
                    <i class="fas fa-user-circle"></i>
                {% endif %}
            </div>
            <div class="user-name">{{ customer.full_name }}</div>
        </div>
    </div>

    <!-- PDF Download Button -->
    <div class="profile-actions">
        <button id="downloadPDF" class="btn-download">
            <i class="fas fa-file-pdf"></i> Download Bank Statement (PDF)
        </button>
    </div>

    <!-- Profile Section -->
    <div class="profile-container">
        <div class="profile-card">
            <h2 class="section-title">Profile Information</h2>
            <div class="profile-details">
                <p><strong>Full Name:</strong> {{ customer.full_name }}</p>
                <p><strong>Username:</strong> {{ customer.username }}</p>
                <p><strong>Email:</strong> {{ request.user.email }}</p>
                <p><strong>ID Card:</strong> {{ customer.id_card|default:"N/A" }}</p>
                <p><strong>Biometric Login:</strong>
                    {% if customer.is_biometric_enabled %}
                        <span style="color:green;">Enabled</span>
                    {% else %}
                        <span style="color:red;">Disabled</span>
                    {% endif %}
                </p>
                <p><strong>Joined:</strong> {{ request.user.date_joined|date:"M d, Y" }}</p>
            </div>
        </div>
    </div>

    <!-- Accounts Section -->
    <div class="accounts-section">
        <h2 class="section-title">My Accounts</h2>
        <div class="accounts-list">
            {% for account in accounts %}
            <div class="account-card">
                <h3>{{ account.get_account_type_display }}</h3>
                <p><strong>Account Number:</strong> {{ account.account_number }}</p>
                <p><strong>Balance:</strong> ₵{{ account.balance }}</p>
                <p><strong>Status:</strong> {{ account.get_status_display }}</p>
            </div>
            {% empty %}
            <p>You don’t have any accounts yet.</p>
            {% endfor %}
        </div>
    </div>

    <!-- Transactions Section -->
    <div class="transactions-section">
        <h2 class="section-title">Recent Transactions</h2>

        <!-- Filters -->
        <div class="filters">
            <label>
                Type:
                <select id="filterType">
                    <option value="all">All</option>
                    <option value="deposit">Deposit</option>
                    <option value="withdrawal">Withdrawal</option>
                    <option value="transfer">Transfer</option>
                </select>
            </label>
            <label>
                From:
                <input type="date" id="filterFrom">
            </label>
            <label>
                To:
                <input type="date" id="filterTo">
            </label>
            <button id="applyFilters" class="btn-filter">Apply</button>
        </div>

        <table class="transactions-table" id="transactionsTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for tx in transactions %}
                <tr data-type="{{ tx.transaction_type|lower }}" data-date="{{ tx.timestamp|date:'Y-m-d' }}">
                    <td>{{ tx.timestamp|date:"M d, Y H:i" }}</td>
                    <td>{{ tx.get_transaction_type_display }}</td>
                    <td>{{ tx.description|default:"-" }}</td>
                    <td class="{% if tx.transaction_type in 'WITHDRAWAL,TRANSFER' %}debit{% else %}credit{% endif %}">
                        {% if tx.transaction_type in 'WITHDRAWAL,TRANSFER' %}-{% else %}+{% endif %}₵{{ tx.amount }}
                    </td>
                    <td>
                        <span class="transaction-status status-{{ tx.status|lower }}">
                            {{ tx.get_status_display }}
                        </span>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="text-align: center;">No recent transactions found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
.profile-container, .accounts-section, .transactions-section {
    margin-top: 2rem;
    padding: 1.5rem;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.profile-card .profile-details p {
    margin: 0.5rem 0;
}
.profile-avatar-img {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
}
.accounts-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1rem;
}
.account-card {
    padding: 1rem;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #fafafa;
}
.transactions-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}
.transactions-table th, .transactions-table td {
    padding: 0.75rem;
    border: 1px solid #ddd;
    text-align: left;
}
.transactions-table th {
    background: #f4f4f4;
}
.transaction-status {
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-size: 0.85rem;
}
.status-completed { background: #d4edda; color: #155724; }
.status-pending { background: #fff3cd; color: #856404; }
.status-failed { background: #f8d7da; color: #721c24; }
.debit { color: red; }
.credit { color: green; }
.profile-actions {
    margin-top: 1rem;
    display: flex;
    gap: 1rem;
}
.btn-download {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.6rem 1.2rem;
    background: #dc3545;
    color: #fff;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 500;
    transition: background 0.3s;
    border: none;
    cursor: pointer;
}
.btn-download:hover { background: #b52b3a; }
.filters {
    margin: 1rem 0;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: center;
}
.btn-filter {
    padding: 0.5rem 1rem;
    background: #007bff;
    color: #fff;
    border-radius: 6px;
    border: none;
    cursor: pointer;
}
.btn-filter:hover { background: #0056b3; }
</style>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const sidebar = document.getElementById('sidebar');
document.getElementById('menuToggle').addEventListener('click', e => {
    e.stopPropagation();
    sidebar.classList.toggle('active');
});
document.addEventListener('click', e => {
    if (window.innerWidth <= 992 && !sidebar.contains(e.target)) {
        sidebar.classList.remove('active');
    }
});

// Filters
document.getElementById("applyFilters").addEventListener("click", () => {
    const type = document.getElementById("filterType").value;
    const from = document.getElementById("filterFrom").value;
    const to = document.getElementById("filterTo").value;

    document.querySelectorAll("#transactionsTable tbody tr").forEach(row => {
        const rowType = row.dataset.type;
        const rowDate = row.dataset.date;

        let visible = true;

        if (type !== "all" && rowType !== type) visible = false;
        if (from && rowDate < from) visible = false;
        if (to && rowDate > to) visible = false;

        row.style.display = visible ? "" : "none";
    });
});

// PDF Download
document.getElementById("downloadPDF").addEventListener("click", () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(16);
    doc.text("Bank Statement", 80, 20);

    doc.setFontSize(12);
    let y = 40;

    document.querySelectorAll("#transactionsTable tbody tr").forEach(row => {
        if (row.style.display === "none") return; // skip hidden rows
        const cols = row.querySelectorAll("td");
        let line = "";
        cols.forEach(col => line += col.innerText + " | ");
        doc.text(line, 10, y);
        y += 10;
        if (y > 280) {
            doc.addPage();
            y = 20;
        }
    });

    doc.save("bank_statement.pdf");
});
</script>
{% endblock %}
